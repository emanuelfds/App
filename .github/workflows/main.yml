name: Python application

on:
  push:
    branches: [ "rc", "develop", "main"]

permissions: write-all

jobs:
  trivy-scanning:
    name: trivy-sec-scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      # - name: Run Trivy vulnerability scanner in repo mode
      #   uses: aquasecurity/trivy-action@master
      #   with:
      #     scan-type: 'fs'
      #     ignore-unfixed: true
      #     format: 'sarif'
      #     output: 'trivy-results.sarif'
      #     severity: 'HIGH,CRITICAL'

  build:
    needs: trivy-scanning
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: Set up Python 3.10
      uses: actions/setup-python@v3
      with:
        python-version: "3.10"
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install flake8 pytest
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
    - name: Lint with flake8
      run: |
        # stop the build if there are Python syntax errors or undefined names
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        # exit-zero treats all errors as warnings. The GitHub editor is 127 chars wide
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
  docker:
        needs: build
        # runs-on: python:3.13.0a4-alpine3.19
        runs-on: ubuntu-latest
        steps:
          - name: Checkout
            uses: actions/checkout@v3

          - name: Set up QEMU
            uses: docker/setup-qemu-action@v2
          
          - name: Set up Docker Buildx
            uses: docker/setup-buildx-action@v2
          
          - name: Login to Docker Hub
            uses: docker/login-action@v2
            with:
              username: ${{ secrets.DOCKERHUB_USERNAME }}
              password: ${{ secrets.DOCKERHUB_TOKEN }}
          
          - name: Increase version
            if:  github.ref == 'refs/heads/rc'
            run: |
              python increase-version.py component_version ${{ github.ref }}
              echo "NEW_VERSION=$(cat component_version)" >> $GITHUB_ENV

          - name: Build and push
            if: github.ref == 'refs/heads/rc' 
            uses: docker/build-push-action@v4
            with:
              context: ./Application
              push: true
              tags: emanuelfds/app:v${{ env.NEW_VERSION }}

          - name: Run Trivy vulnerability scanner
            uses: aquasecurity/trivy-action@master
            with:
              image-ref: 'emanuelfds/app:v${{ github.run_number }}'
              # format: 'table'
              format: 'sarif'
              output: 'trivy-results.sarif'
              # if 'exit-code: 1' your pipeline will be interrupted
              exit-code: '0'    
              ignore-unfixed: true
              vuln-type: 'os,library'
              severity: 'CRITICAL,HIGH,MEDIUM'

          - 
            name: Upload Trivy scan results to GitHub Security tab
            uses: github/codeql-action/upload-sarif@v3
            if: always()
            with:
              sarif_file: 'trivy-results.sarif'

  # modifygit:
  #   needs: docker
  #   runs-on: ubuntu-latest
  #   steps:
  #     - uses: actions/checkout@v3
  #       name: changing the deployment of git repo
  #       with:
  #         repository: 'emanuelfds/App-Manifest'
  #         token: ${{ secrets.GIT_PAT }}
  #         persist-credentials: true
  #     - name: modify the image
  #       run: |
  #         git config user.email ${{ vars.GIT_EMAIL }}
  #         git config user.name "${{ vars.GIT_USERNAME }}"
  #         pwd
  #         cat ${{ vars.K8S_PATH }}/deployment.yaml
  #         pwd
  #         sed -i "s+emanuelfds/app.*+emanuelfds/app:v$RUN_NUMBER+g" ${{ vars.K8S_PATH }}/deployment.yaml
  #         cat ${{ vars.K8S_PATH }}/deployment.yaml
  #         git add .
  #         git commit -m 'Versão da Aplicação alterada para a TAG: ${{ github.run_number }}'
  #         git push origin main
  #       env:
  #         RUN_NUMBER: ${{ github.run_number }}